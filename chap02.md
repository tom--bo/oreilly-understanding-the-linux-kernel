# 2章 メモリアドレッシング

この章では、アドレッシング方法について説明する。  
幸いなことに、OSは物理メモリ管理の全てを行う必要はない。  
最近のプロセッサは、メモリ管理を行うハードウェア回路を装備しており、メモリ管理をより効率的且つ確実に行うことが出来る。  
従って、プログラムエラーがあっても、そのプログラムの領域外のメモリに誤ってアクセスしてしまうことはない。  

本書を読み進めるのに必要な知識として、この章では、80x86プロセッサがどのようにメモリチップをアドレス付するのか、また、Linuxがどのようにアドレッシング回路を利用しているのかについて詳細に説明する。  
Linuxが最も普及しているプラットフォームでの実装を詳細に学ぶことにより、ページングの
一般的な方法論と、他のプラットフォームでの実装の両方を理解する。

本書にはメモリ管理に関する章が3つあり、この章が1番目。  
8章では、カーネル内部のためにどのようにメインメモリを割り当てるかについて、  
9章では、リニアアドレスをどのようにプロセスに割り当てるかについて説明する。

## 2.1 メモリアドレス

プログラムは、メモリの番地（アドレス）を参照することで、メモリセルの内容にアクセスする。  
しかし、80x86プロセッサの場合は、次の3種類のアドレスを区別しなければならない。

- 論理アドレス
  - マシン語において、オペランドや命令のアドレスを指定するときに使用するアドレス
  - 論理アドレスは、有名な「80x86セグメント管理アーキテクチャ」を代表するもの
  - 論理アドレスは、セグメントとオフセットからなり、オフセットはセグメントの先頭から実際のアドレスまでの差を表す

- リニアアドレス
  - 一般で言う仮想アドレス
  - 4GB、つまり4,294,967,296個のメモリセルを指定できる32ビットの符号なし整数で表現できる
  - リニアアドレスは、通常16進数で表し、0x00000000から0xffffffffまでの値を取る

- 物理アドレス
  - メモリチップ内のメモリセルを指定する際に使用する
  - メモリセルの指定とは、プロセッサのアドレス品を通じて、電気信号をメモリバスに送ることを意味する
  - 物理アドレスは32ビットまたは、36ビットの符号なし整数で表現する

メモリ管理回路(MMU)は、セグメンテーション回路というハードウェアを用いて、論理アドレスをリニアアドレスに変換する  
そのあと、ページング回路を用いて、リニアアドレスを物理アドレスに変換する

図2-1 論理アドレス変換

マルチプロセッサシステムでは、通常全てのCPUが同じメモリを共有する。  
これはRAMチップを別々のCPUから同時にアクセスする可能性があることを意味している。  
RAMチップの読み取りや書き込みは逐次に行う必要があり、バスト全てのRAMチップの間にメモリ調停回路(memory arbiter)を配置している。  
単一のプロセッサシステムの場合でも、DMAコントローラが存在するため、メモリ調停回路を使用する。  
この仕組はマルチプロセッサシステムの場合は複雑になるが、これらの調停処理はハードウェア回路が行うので、プログラミングの観点から意識することはない。


## 2.2 ハードウェアのセグメント機構
80286以降のIntelプロセッサには、リアルモードとプロテクトモードと言う2種類のプロセッサ動作モードがあり、それぞれでアドレス変換方法が異なる。  
次節では、プロテクトモードにおけるアドレス変換を中心に説明する。  
リアルモードは主に古いモデルとの互換性のために残してあり、OSの起動時に使用する。


### 2.2.1 セグメントセレクタとセグメントレジスタ



### 2.2.2 セグメントディスクリプタ


### 2.2.3 セグメントディスクリプタへの高速アクセス


### 2.2.4 セグメンテーション回路



## 2.3 Linuxのセグメント機構



### 2.3.1 LinuxのGDT



### 2.3.2 LinuxのLDT


## 2.4 ハードウェアのページング機構



### 2.4.1 通常のページング


### 2.4.2 拡張ページング


### 2.4.3 ハードウェア保護機構


### 2.4.4 通常ページングの例


### 2.4.5 物理アドレス拡張ページング機構


### 2.4.6 64ビットアーキテクチャにおけるページング



### 2.4.7 ハードウェアキャッシュ


### 2.4.8 アドレス変換バッファ(TLB)









.
